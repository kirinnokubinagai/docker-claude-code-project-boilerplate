# Stage 1: ビルドステージ
FROM node:alpine AS builder

# Claude Codeをインストール
RUN apk add --no-cache pnpm
ENV PNPM_HOME=/usr/local/share/pnpm
ENV PATH=$PNPM_HOME:$PATH
RUN mkdir -p $PNPM_HOME \
    && pnpm config set global-bin-dir $PNPM_HOME \
    && pnpm config set global-dir $PNPM_HOME \
    && pnpm config set store-dir $PNPM_HOME/.pnpm-store

RUN pnpm config set enable-pre-post-scripts true && \
    pnpm install -g @anthropic-ai/claude-code

# Stage 2: 実行ステージ
FROM node:alpine

# パッケージのインストールを1つのRUNにまとめる（レイヤー削減）
RUN apk add --no-cache \
    bash bash-completion git curl coreutils sudo \
    musl-locales musl-locales-lang \
    fzf tmux jq perl gettext ncurses vim \
    python3 py3-pip \
    pnpm \
    docker-cli docker-cli-compose \
    github-cli \
    # Chromium（最小限の依存関係のみ）
    chromium nss freetype harfbuzz ca-certificates ttf-freefont \
    && rm -rf /var/cache/apk/*

# pecoのインストール
RUN curl -L https://github.com/peco/peco/releases/download/v0.5.11/peco_linux_amd64.tar.gz | tar xz \
    && mv peco_linux_amd64/peco /usr/local/bin/ \
    && rm -rf peco_linux_amd64

# Python用ツール
RUN pip3 install --no-cache-dir --break-system-packages uv

# z.shのインストール
RUN curl -fsSL https://raw.githubusercontent.com/rupa/z/master/z.sh > /usr/local/bin/z.sh \
    && chmod +x /usr/local/bin/z.sh

# developerユーザーを作成
RUN addgroup -g 1001 developer && \
    adduser -D -u 1001 -G developer -s /bin/bash developer && \
    echo "developer ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/developer && \
    chmod 0440 /etc/sudoers.d/developer

# 必要なディレクトリを作成
RUN mkdir -p /workspace /home/developer /opt/system && \
    chown -R developer:developer /workspace /home/developer

# ロケール環境変数を設定
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# pnpm設定をコピー
ENV PNPM_HOME=/usr/local/share/pnpm
ENV PATH=$PNPM_HOME:$PATH

# Claude Codeをbuilderからコピー
COPY --from=builder $PNPM_HOME $PNPM_HOME

# entrypointスクリプトをコピー
RUN mkdir -p /opt/system
COPY docker-entrypoint.sh /opt/system/docker-entrypoint.sh
RUN chmod +x /opt/system/docker-entrypoint.sh

# システム設定ディレクトリを作成
RUN mkdir -p /opt/claude-system

# Bash設定ファイルをコピー
COPY docker-base/bash/.bashrc /home/developer/.bashrc
COPY docker-base/bash/.bash_profile /home/developer/.bash_profile
RUN chown developer:developer /home/developer/.bashrc /home/developer/.bash_profile

# 作業ディレクトリを設定
WORKDIR /workspace

# entrypointを設定
ENTRYPOINT ["/opt/system/docker-entrypoint.sh"]